generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  DELIVERING
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CASH
  PIX
  CREDIT_CARD
  DEBIT_CARD
}

enum TokenType {
  PASSWORD_RECOVER
}

enum AccountProvider {
  GOOGLE
}

enum Role {
  ADMIN
  CUSTOMER
}

model User {
  id           String    @id @default(cuid())
  name         String?
  email        String    @unique
  phone        String?
  passwordHash String?   @map("password_hash")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  role         Role
  accounts     Account[]
  addresses    Address[]
  orders       Order[]
  tokens       Token[]

  @@map("users")
}

model Token {
  id        String    @id @default(uuid())
  type      TokenType
  createdAt DateTime  @default(now()) @map("created_at")
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("tokens")
}

model Account {
  id                String          @id @default(uuid())
  provider          AccountProvider
  providerAccountId String          @unique @map("provider_account_id")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  userId            String          @map("user_id")
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, userId])
  @@map("account")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?   @db.Text
  products    Product[]
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("categories")
}

model Product {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String      @db.Text
  price       Int
  image       String
  categoryId  String
  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  popular     Boolean     @default(false)
  available   Boolean     @default(true)
  orderItems  OrderItem[]
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@index([categoryId])
  @@index([popular])
  @@index([available])
  @@map("products")
}

model Order {
  id            String               @id @default(cuid())
  orderNumber   Int                  @unique @default(autoincrement())
  customerId    String               @map("customer_id")
  customer      User                 @relation(fields: [customerId], references: [id], onDelete: Cascade)
  addressId     String               @map("address_id")
  address       Address              @relation(fields: [addressId], references: [id])
  items         OrderItem[]
  subtotal      Int
  deliveryFee   Int                  @default(500) @map("delivery_fee")
  total         Int
  paymentMethod PaymentMethod        @map("payment_method")
  changeFor     Int?                 @map("change_for")
  status        OrderStatus          @default(PENDING)
  statusHistory OrderStatusHistory[]
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String   @map("order_id")
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String   @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  quantity  Int
  unitPrice Int      @map("unit_price")
  subtotal  Int
  createdAt DateTime @default(now()) @map("created_at")

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Address {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  zipCode      String
  reference    String?
  isDefault    Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  orders       Order[]

  @@map("addresses")
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String      @map("order_id")
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    OrderStatus
  createdAt DateTime    @default(now()) @map("created_at")

  @@index([orderId])
  @@map("order_status_history")
}
